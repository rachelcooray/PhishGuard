from flask import Blueprint, request, jsonify
import hashlib
import os

malware_bp = Blueprint('malware', __name__)

# Mock Database of known malicious hashes (EICAR test string MD5)
KNOWN_MALWARE_HASHES = {
    "44d88612fea8a8f36de82e1278abb02f": "EICAR-Test-File",
    "5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8": "Ransomware.WannaCry (Mock)",
    "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855": "Empty File (Safe)" 
}

@malware_bp.route('/scan', methods=['POST'])
def scan_file():
    if 'file' not in request.files:
        return jsonify({"error": "No file part"}), 400
    
    file = request.files['file']
    if file.filename == '':
        return jsonify({"error": "No selected file"}), 400

    # Read file content
    content = file.read()
    
    # Calculate Hashes
    md5_hash = hashlib.md5(content).hexdigest()
    sha256_hash = hashlib.sha256(content).hexdigest()

    # Check against DB
    threat_name = KNOWN_MALWARE_HASHES.get(md5_hash) or KNOWN_MALWARE_HASHES.get(sha256_hash)
    
    is_malicious = threat_name is not None
    
    # In a real app, we would send 'sha256_hash' to VirusTotal API here
    
    return jsonify({
        "filename": file.filename,
        "md5": md5_hash,
        "sha256": sha256_hash,
        "is_malicious": is_malicious,
        "threat_name": threat_name if is_malicious else "Clean",
        "message": f"Detected {threat_name}" if is_malicious else "No threats found in internal database."
    })
